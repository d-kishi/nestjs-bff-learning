# US012: ユーザー管理

## ストーリー

ADMINユーザーとして、
システム内のユーザーを一覧表示・検索・管理したい。
それにより、ユーザーアカウントの状態を適切に管理できる。

## 受け入れ基準

- ADMINはユーザー一覧を取得できる（ページネーション、フィルタリング対応）
- ADMINはユーザーのアカウント状態（有効/無効）を変更できる
- ADMINはユーザーにロールを付与・削除できる
- ADMINはユーザーを削除できる
- MEMBERはこれらの管理機能にアクセスできない

## アンチパターン（これは仕様に含まない）

- ADMINであっても他ユーザーのパスワードは変更できない
- ユーザー削除は物理削除であり、復元できない
- ADMINが自分自身のADMINロールを削除することは可能（最後のADMIN対策は実装しない）

## テストシナリオ

### 正常系

#### シナリオ1: ADMINがユーザー一覧を取得

- **Given（前提）**: ADMINユーザー（X-User-Roles: ADMIN）でログイン済み、システムに10人のユーザーが存在
- **When（操作）**: GET /users を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - ユーザー一覧（パスワードは含まない）とページネーション情報が返る

#### シナリオ2: ADMINがメールアドレスでユーザーを検索

- **Given（前提）**: ADMINユーザーでログイン済み
- **When（操作）**: GET /users?email=test を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - メールアドレスに "test" を含むユーザーのみが返る

#### シナリオ3: ADMINがユーザーのアカウントを無効化

- **Given（前提）**: ADMINユーザーでログイン済み、ユーザーID 5 が存在（isActive: true）
- **When（操作）**: PATCH /users/5/status に `{"isActive": false}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - ユーザーID 5 の isActive が false になる
  - ユーザーID 5 の全Refresh Tokenが無効化される

#### シナリオ4: ADMINがユーザーにADMINロールを付与

- **Given（前提）**: ADMINユーザーでログイン済み、ユーザーID 5 がMEMBERロールのみ保持
- **When（操作）**: PATCH /users/5/roles に `{"roleIds": [1, 2]}` を送信（1: ADMIN, 2: MEMBER）
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - ユーザーID 5 のロールが ADMIN, MEMBER になる

#### シナリオ5: ADMINがユーザーを削除

- **Given（前提）**: ADMINユーザーでログイン済み、ユーザーID 5 が存在
- **When（操作）**: DELETE /users/5 を送信
- **Then（結果）**:
  - HTTPステータス 204 が返る
  - ユーザーID 5 が物理削除される
  - 関連するUserProfileも削除される

### 異常系

#### シナリオ6: MEMBERがユーザー一覧にアクセス

- **Given（前提）**: MEMBERユーザー（X-User-Roles: MEMBER）でログイン済み
- **When（操作）**: GET /users を送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `USER_USER_FORBIDDEN` が返る

#### シナリオ7: MEMBERがユーザーのロールを変更しようとする

- **Given（前提）**: MEMBERユーザーでログイン済み
- **When（操作）**: PATCH /users/5/roles を送信
- **Then（結果）**:
  - HTTPステータス 403 が返る

#### シナリオ8: 存在しないユーザーを削除

- **Given（前提）**: ADMINユーザーでログイン済み
- **When（操作）**: DELETE /users/9999 を送信
- **Then（結果）**:
  - HTTPステータス 404 が返る
  - エラーコード `USER_USER_NOT_FOUND` が返る

#### シナリオ9: 存在しないロールIDを指定

- **Given（前提）**: ADMINユーザーでログイン済み
- **When（操作）**: PATCH /users/5/roles に `{"roleIds": [999]}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_ROLE_NOT_FOUND` が返る

## 補足: ロール管理API

ADMINはロール自体の作成・更新・削除も可能。

#### シナリオ10: ADMINが新しいロールを作成

- **Given（前提）**: ADMINユーザーでログイン済み
- **When（操作）**: POST /roles に `{"name": "EDITOR", "description": "編集者"}` を送信
- **Then（結果）**:
  - HTTPステータス 201 が返る
  - 新しいロール EDITOR が作成される

#### シナリオ11: ユーザーが割り当てられているロールを削除しようとする

- **Given（前提）**: ADMINユーザーでログイン済み、ロールID 2 (MEMBER) に5人のユーザーが割り当て済み
- **When（操作）**: DELETE /roles/2 を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_ROLE_HAS_USERS` が返る
  - メッセージに割り当て済みユーザー数が含まれる

## 関連

- US008: ユーザー登録（ADMINがユーザーを管理）
- US009: ログイン（無効化されたアカウントはログイン不可）
- US010: プロフィール更新（ADMINによる他ユーザーのプロフィール更新）
