# US009: ログイン

## ストーリー

登録済みユーザーとして、
メールアドレスとパスワードでログインしたい。
それにより、自分のタスクやプロジェクトにアクセスできる。

## 受け入れ基準

- メールアドレスとパスワードでログインできる
- ログイン成功時、Access TokenとRefresh Tokenが発行される
- ログインに使用したユーザー情報（ID、メール、表示名、ロール）が返却される
- 無効なアカウント（isActive: false）ではログインできない
- 古いRefresh Tokenは無効化され、新しいトークンのみ有効

## アンチパターン（これは仕様に含まない）

- ログイン失敗回数によるアカウントロックは実装しない（学習用のため）
- ソーシャルログイン（Google, GitHub等）は実装しない
- 二要素認証（2FA）は実装しない
- 「パスワードを忘れた」機能は実装しない

## テストシナリオ

### 正常系

#### シナリオ1: 有効な認証情報でログイン

- **Given（前提）**: `user@example.com` / `Password123` で登録済み、アカウントが有効（isActive: true）
- **When（操作）**: POST /auth/login に `{"email": "user@example.com", "password": "Password123"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - レスポンスに `user`, `accessToken`, `refreshToken` が含まれる
  - `user` にはパスワードが含まれない

#### シナリオ2: 再ログイン時に古いRefresh Tokenが無効化される

- **Given（前提）**: ユーザーが既にログイン済みで Refresh Token A を保持
- **When（操作）**: 同じユーザーが再度ログイン
- **Then（結果）**:
  - 新しい Refresh Token B が発行される
  - Refresh Token A は無効化される（使用不可）

### 異常系

#### シナリオ3: 存在しないメールアドレス

- **Given（前提）**: `unknown@example.com` は未登録
- **When（操作）**: POST /auth/login に `{"email": "unknown@example.com", "password": "Password123"}` を送信
- **Then（結果）**:
  - HTTPステータス 401 が返る
  - エラーコード `USER_AUTH_INVALID_CREDENTIALS` が返る
  - エラーメッセージは具体的な理由を明かさない（セキュリティ）

#### シナリオ4: パスワードが間違っている

- **Given（前提）**: `user@example.com` は登録済みだがパスワードが異なる
- **When（操作）**: POST /auth/login に `{"email": "user@example.com", "password": "WrongPassword"}` を送信
- **Then（結果）**:
  - HTTPステータス 401 が返る
  - エラーコード `USER_AUTH_INVALID_CREDENTIALS` が返る

#### シナリオ5: アカウントが無効化されている

- **Given（前提）**: `disabled@example.com` が登録済みだが isActive: false
- **When（操作）**: POST /auth/login に正しい認証情報を送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `USER_AUTH_ACCOUNT_DISABLED` が返る

## 関連

- US008: ユーザー登録
- US011: パスワード変更
- US012: ユーザー管理（ADMINによるアカウント無効化）
