# US020: ADMIN機能

## ストーリー

ADMINロールを持つユーザーとして、
Angularアプリケーションでユーザー管理・ロール管理を行いたい。
それにより、システムのユーザーとロールを管理できる。

## 受け入れ基準

### ユーザー管理（`/admin/users`）
- ユーザー一覧が表示される
- ユーザーのロールを変更できる
- ユーザーのステータス（有効/無効）を変更できる
- ページネーションで20件ずつ表示される

### ロール管理（`/admin/roles`）
- ロール一覧が表示される
- ロールを新規作成できる
- ロールを編集できる
- システムロール（ADMIN, MEMBER）以外は削除できる

### アクセス制御
- ADMIN権限がないユーザーはアクセスできない
- 権限がない場合はダッシュボードへリダイレクトされる

## アンチパターン（これは仕様に含まない）

- ユーザーの新規作成（登録は各ユーザーが行う）
- ユーザーの削除
- 詳細な権限設定（パーミッション管理）

---

## テストシナリオ

### 正常系

#### シナリオ1: ユーザー一覧表示

- **Given（前提）**:
  - ADMINユーザーでログイン済み
  - システムに30人のユーザーが登録されている
- **When（操作）**:
  - ユーザー管理画面（`/admin/users`）にアクセス
- **Then（結果）**:
  - 1ページ目に20件表示される
  - 各ユーザーにEmail、表示名、ロール、ステータス、操作ボタンが表示される

#### シナリオ2: ユーザーロール変更

- **Given（前提）**:
  - ユーザー管理画面を表示中
  - 「user1@example.com」はMEMBERロールのみ
- **When（操作）**:
  - 「user1@example.com」の「ロール」ボタンをクリック
  - ロール編集ダイアログが表示される
  - 「ADMIN」チェックボックスをオンにする
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - ダイアログが閉じる
  - 「ロールを更新しました」トーストが表示される
  - 一覧のロール列が「ADMIN, MEMBER」に更新される

#### シナリオ3: ユーザーステータス変更（無効化）

- **Given（前提）**:
  - ユーザー管理画面を表示中
  - 「user1@example.com」は有効状態
- **When（操作）**:
  - 「user1@example.com」の「ステータス」ボタンをクリック
  - 確認ダイアログ「無効化しますか？」が表示される
  - 「実行」ボタンをクリック
- **Then（結果）**:
  - ダイアログが閉じる
  - 「ステータスを更新しました」トーストが表示される
  - 一覧のステータス列が「無効」に更新される

#### シナリオ4: ユーザーステータス変更（有効化）

- **Given（前提）**:
  - ユーザー管理画面を表示中
  - 「user2@example.com」は無効状態
- **When（操作）**:
  - 「user2@example.com」の「ステータス」ボタンをクリック
  - 確認ダイアログ「有効化しますか？」が表示される
  - 「実行」ボタンをクリック
- **Then（結果）**:
  - 一覧のステータス列が「有効」に更新される

#### シナリオ5: ロール一覧表示

- **Given（前提）**:
  - ADMINユーザーでログイン済み
- **When（操作）**:
  - ロール管理画面（`/admin/roles`）にアクセス
- **Then（結果）**:
  - ロール一覧が表示される
  - ADMIN、MEMBERは削除ボタンが非表示または無効
  - カスタムロールは編集・削除ボタンが表示される

#### シナリオ6: ロール新規作成

- **Given（前提）**:
  - ロール管理画面を表示中
- **When（操作）**:
  - 「+ 新規作成」ボタンをクリック
  - ダイアログが表示される
  - ロール名に「VIEWER」を入力
  - 説明に「閲覧専用ロール」を入力
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - ダイアログが閉じる
  - 「ロールを作成しました」トーストが表示される
  - 一覧に「VIEWER」が追加される

#### シナリオ7: ロール編集

- **Given（前提）**:
  - ロール管理画面を表示中
  - 「VIEWER」ロールが存在
- **When（操作）**:
  - 「VIEWER」の「編集」ボタンをクリック
  - 説明を「閲覧のみ可能なロール」に変更
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - 「ロールを更新しました」トーストが表示される
  - 一覧の説明が更新される

#### シナリオ8: ロール削除

- **Given（前提）**:
  - ロール管理画面を表示中
  - 「VIEWER」ロールが存在（どのユーザーにも付与されていない）
- **When（操作）**:
  - 「VIEWER」の「削除」ボタンをクリック
  - 確認ダイアログで「削除」をクリック
- **Then（結果）**:
  - 「ロールを削除しました」トーストが表示される
  - 一覧から「VIEWER」が削除される

---

### 異常系

#### シナリオ9: 権限なしでのアクセス（ユーザー管理）

- **Given（前提）**:
  - MEMBERロールのみのユーザーでログイン済み
- **When（操作）**:
  - `/admin/users` に直接アクセス
- **Then（結果）**:
  - adminGuardによりアクセス拒否
  - `/dashboard` へリダイレクトされる

#### シナリオ10: 権限なしでのアクセス（ロール管理）

- **Given（前提）**:
  - MEMBERロールのみのユーザーでログイン済み
- **When（操作）**:
  - `/admin/roles` に直接アクセス
- **Then（結果）**:
  - adminGuardによりアクセス拒否
  - `/dashboard` へリダイレクトされる

#### シナリオ11: システムロール削除の試行

- **Given（前提）**:
  - ロール管理画面を表示中
- **When（操作）**:
  - 「ADMIN」または「MEMBER」ロールを確認
- **Then（結果）**:
  - 削除ボタンが表示されない、または無効化されている

#### シナリオ12: 使用中ロールの削除

- **Given（前提）**:
  - ロール管理画面を表示中
  - 「VIEWER」ロールがユーザーに付与されている
- **When（操作）**:
  - 「VIEWER」の「削除」ボタンをクリック
  - 確認ダイアログで「削除」をクリック
- **Then（結果）**:
  - エラートースト「このロールは使用中のため削除できません」が表示される
  - ロールは削除されない

#### シナリオ13: ロール名重複

- **Given（前提）**:
  - ロール新規作成ダイアログを表示中
  - 「VIEWER」ロールが既に存在
- **When（操作）**:
  - ロール名に「VIEWER」を入力
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - エラートースト「このロール名は既に使用されています」が表示される
  - ダイアログは開いたまま

#### シナリオ14: 自分自身のADMINロール削除

- **Given（前提）**:
  - ADMINユーザーでログイン済み
  - ロール編集ダイアログで自分自身を選択
- **When（操作）**:
  - 自分のADMINロールを外そうとする
- **Then（結果）**:
  - 警告メッセージ「自分自身のADMINロールは削除できません」が表示される
  - または、自分自身のADMIN権限のチェックボックスが無効化されている

---

## E2Eテスト（/webapp-testing用）

### テストスイート構成

```typescript
describe('ADMIN機能', () => {
  describe('アクセス制御', () => {
    it('ADMINユーザーはユーザー管理にアクセスできる');
    it('ADMINユーザーはロール管理にアクセスできる');
    it('非ADMINユーザーはダッシュボードにリダイレクトされる');
  });

  describe('ユーザー管理', () => {
    beforeEach(() => {
      // ADMINユーザーでログイン
    });

    it('ユーザー一覧が表示される');
    it('ユーザーのロールを変更できる');
    it('ユーザーを無効化できる');
    it('ユーザーを有効化できる');
  });

  describe('ロール管理', () => {
    beforeEach(() => {
      // ADMINユーザーでログイン
    });

    it('ロール一覧が表示される');
    it('ロールを新規作成できる');
    it('ロールを編集できる');
    it('カスタムロールを削除できる');
    it('システムロールは削除できない');
  });
});
```

---

## 関連ドキュメント

- `docs/design/angular-ui-design.md` - ユーザー管理・ロール管理画面ワイヤーフレーム
- `docs/design/angular-architecture.md` - adminGuard設計
- `docs/design/api-gateway-api.md` - ユーザー・ロールAPI仕様
- `docs/user-stories/US012_ユーザー管理.md` - バックエンド仕様
