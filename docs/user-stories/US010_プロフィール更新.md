# US010: プロフィール更新

## ストーリー

登録済みユーザーとして、
自分のプロフィール情報（表示名、アバター、自己紹介等）を更新したい。
それにより、他のユーザーに自分を適切に表示できる。

## 受け入れ基準

- 自分のプロフィールを更新できる
- 更新可能な項目：displayName, firstName, lastName, avatarUrl, bio
- 部分更新（PATCH）が可能で、指定した項目のみ更新される
- ADMINは他のユーザーのプロフィールも更新できる
- 各フィールドには文字数制限がある

## アンチパターン（これは仕様に含まない）

- メールアドレスの変更はプロフィール更新ではなく、別エンドポイント（PATCH /users/:id）で行う
- アバター画像のアップロード機能は実装しない（URLのみ指定）
- プロフィール更新で認証情報（password）は変更できない

## テストシナリオ

### 正常系

#### シナリオ1: displayNameを更新

- **Given（前提）**: ユーザーID 1 でログイン済み（X-User-Id: 1）
- **When（操作）**: PATCH /users/1/profile に `{"displayName": "新しい名前"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - `displayName` が「新しい名前」に更新される
  - 他のフィールド（firstName, lastName等）は変更されない

#### シナリオ2: 複数フィールドを同時に更新

- **Given（前提）**: ユーザーID 1 でログイン済み
- **When（操作）**: PATCH /users/1/profile に `{"firstName": "太郎", "lastName": "山田", "bio": "エンジニアです"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - 指定した3フィールドが全て更新される

#### シナリオ3: ADMINが他ユーザーのプロフィールを更新

- **Given（前提）**: ADMINユーザー（X-User-Roles: ADMIN）でログイン済み
- **When（操作）**: PATCH /users/2/profile に `{"displayName": "管理者が変更"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - ユーザーID 2 のプロフィールが更新される

### 異常系

#### シナリオ4: 他人のプロフィールを更新しようとする（MEMBER）

- **Given（前提）**: MEMBERユーザー（X-User-Id: 1, X-User-Roles: MEMBER）でログイン済み
- **When（操作）**: PATCH /users/2/profile に更新リクエストを送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `USER_USER_FORBIDDEN` が返る

#### シナリオ5: displayNameが文字数制限を超える

- **Given（前提）**: ユーザーID 1 でログイン済み
- **When（操作）**: PATCH /users/1/profile に 101文字の `displayName` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_USER_VALIDATION_ERROR` が返る

#### シナリオ6: avatarUrlが無効なURL形式

- **Given（前提）**: ユーザーID 1 でログイン済み
- **When（操作）**: PATCH /users/1/profile に `{"avatarUrl": "not-a-valid-url"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_USER_VALIDATION_ERROR` が返る

#### シナリオ7: 存在しないユーザーのプロフィールを更新

- **Given（前提）**: ADMINユーザーでログイン済み
- **When（操作）**: PATCH /users/9999/profile にリクエストを送信
- **Then（結果）**:
  - HTTPステータス 404 が返る
  - エラーコード `USER_USER_NOT_FOUND` が返る

## 関連

- US008: ユーザー登録（初期プロフィール作成）
- US012: ユーザー管理（ADMINによる更新）
