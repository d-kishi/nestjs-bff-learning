# US019: プロフィール管理

## ストーリー

認証済みユーザーとして、
Angularアプリケーションで自分のプロフィールを確認・編集したい。
それにより、表示名や自己紹介を更新し、パスワードを変更できる。

## 受け入れ基準

- 自分のプロフィール情報が表示される（表示名、メール、ロール）
- 表示名を編集できる
- 自己紹介を編集できる
- パスワードを変更できる
- 操作成功時にトースト通知が表示される
- バリデーションエラーがフォームに表示される

## アンチパターン（これは仕様に含まない）

- アバター画像のアップロード
- メールアドレスの変更
- アカウント削除
- 二要素認証設定

---

## テストシナリオ

### 正常系

#### シナリオ1: プロフィール表示

- **Given（前提）**:
  - ユーザーはログイン済み
  - 表示名「テストユーザー」、メール「test@example.com」
  - ロール「MEMBER」
- **When（操作）**:
  - プロフィール画面（`/profile`）にアクセス
- **Then（結果）**:
  - 表示名「テストユーザー」が表示される
  - メール「test@example.com」が表示される
  - ロール「MEMBER」が表示される
  - プロフィール編集フォームに現在の値がセットされる

#### シナリオ2: 表示名更新

- **Given（前提）**:
  - プロフィール画面を表示中
  - 現在の表示名は「テストユーザー」
- **When（操作）**:
  - 表示名フィールドを「新しい名前」に変更
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - 「プロフィールを更新しました」トーストが表示される
  - ヘッダーのユーザー名も「新しい名前」に更新される
  - 画面上の表示名も更新される

#### シナリオ3: 自己紹介更新

- **Given（前提）**:
  - プロフィール画面を表示中
- **When（操作）**:
  - 自己紹介フィールドに「こんにちは！よろしくお願いします。」を入力
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - 「プロフィールを更新しました」トーストが表示される
  - 自己紹介が保存される

#### シナリオ4: パスワード変更成功

- **Given（前提）**:
  - プロフィール画面を表示中
  - 現在のパスワードは「OldPassword123」
- **When（操作）**:
  - 「パスワード変更」ボタンをクリック
  - ダイアログが表示される
  - 現在のパスワードに「OldPassword123」を入力
  - 新しいパスワードに「NewPassword456」を入力
  - 確認用パスワードに「NewPassword456」を入力
  - 「変更」ボタンをクリック
- **Then（結果）**:
  - ダイアログが閉じる
  - 「パスワードを変更しました」トーストが表示される
  - 次回ログイン時は新しいパスワードで認証

#### シナリオ5: パスワード変更後の再ログイン

- **Given（前提）**:
  - パスワードを「OldPassword123」から「NewPassword456」に変更済み
- **When（操作）**:
  - ログアウト
  - 「NewPassword456」でログイン
- **Then（結果）**:
  - ログイン成功

---

### 異常系

#### シナリオ6: バリデーションエラー（表示名空）

- **Given（前提）**:
  - プロフィール画面を表示中
- **When（操作）**:
  - 表示名フィールドを空にする
  - 「保存」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - 表示名フィールドに「必須項目です」エラーが表示される

#### シナリオ7: パスワード変更失敗（現在のパスワード誤り）

- **Given（前提）**:
  - パスワード変更ダイアログを表示中
- **When（操作）**:
  - 現在のパスワードに誤った値を入力
  - 新しいパスワードに「NewPassword456」を入力
  - 確認用パスワードに「NewPassword456」を入力
  - 「変更」ボタンをクリック
- **Then（結果）**:
  - ダイアログは開いたまま
  - エラーメッセージ「現在のパスワードが正しくありません」が表示される

#### シナリオ8: パスワード変更失敗（確認用パスワード不一致）

- **Given（前提）**:
  - パスワード変更ダイアログを表示中
- **When（操作）**:
  - 現在のパスワードに正しい値を入力
  - 新しいパスワードに「NewPassword456」を入力
  - 確認用パスワードに「DifferentPassword」を入力
  - 「変更」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - 確認用パスワードフィールドに「パスワードが一致しません」エラーが表示される

#### シナリオ9: パスワード変更失敗（新パスワード文字数不足）

- **Given（前提）**:
  - パスワード変更ダイアログを表示中
- **When（操作）**:
  - 現在のパスワードに正しい値を入力
  - 新しいパスワードに「short」を入力（8文字未満）
  - 確認用パスワードに「short」を入力
  - 「変更」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - 新しいパスワードフィールドに「パスワードは8文字以上で入力してください」エラーが表示される

---

## E2Eテスト（/webapp-testing用）

### テストスイート構成

```typescript
describe('プロフィール管理', () => {
  beforeEach(() => {
    // ログイン済み状態をセットアップ
  });

  describe('表示', () => {
    it('プロフィール情報が表示される');
    it('ロールが表示される');
  });

  describe('プロフィール編集', () => {
    it('表示名を更新できる');
    it('自己紹介を更新できる');
    it('表示名が空の場合エラーが表示される');
  });

  describe('パスワード変更', () => {
    it('パスワードを変更できる');
    it('現在のパスワードが誤っている場合エラーが表示される');
    it('確認用パスワードが一致しない場合エラーが表示される');
  });
});
```

---

## 関連ドキュメント

- `docs/design/angular-ui-design.md` - プロフィール画面ワイヤーフレーム
- `docs/design/api-gateway-api.md` - ユーザーAPI仕様
- `docs/user-stories/US010_プロフィール更新.md` - バックエンド仕様
- `docs/user-stories/US011_パスワード変更.md` - バックエンド仕様
