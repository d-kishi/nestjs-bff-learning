# US015: Angularログイン

## ストーリー

タスク管理システムのユーザーとして、
Angularアプリケーションでログイン・新規登録を行いたい。
それにより、認証済み状態でタスク管理機能にアクセスできる。

## 受け入れ基準

- ログイン画面でメールアドレスとパスワードを入力してログインできる
- タブ切替で新規登録フォームに切り替えられる
- 新規登録後、自動的にログイン状態になる
- ログイン成功後、ダッシュボード画面へリダイレクトされる
- 入力バリデーションエラーが画面に表示される
- 認証エラー（401）時にエラーメッセージが表示される
- ログイン状態はブラウザリロード後も維持される

## アンチパターン（これは仕様に含まない）

- ソーシャルログイン（Google, GitHub等）
- パスワードリセット機能
- 「ログイン状態を保持する」チェックボックス
- CAPTCHA

## 画面遷移

```
/login → (ログイン成功) → /dashboard
       → (returnUrl指定時) → returnUrlのパス
```

---

## テストシナリオ

### 正常系

#### シナリオ1: ログイン成功

- **Given（前提）**:
  - `test@example.com` / `Password123` で登録済みのユーザーが存在
  - ユーザーは未ログイン状態
- **When（操作）**:
  - ログイン画面（`/login`）にアクセス
  - Emailフィールドに `test@example.com` を入力
  - Passwordフィールドに `Password123` を入力
  - 「ログイン」ボタンをクリック
- **Then（結果）**:
  - ダッシュボード画面（`/dashboard`）へリダイレクトされる
  - ヘッダーにユーザー名が表示される
  - localStorageにトークンが保存される

#### シナリオ2: 新規登録成功

- **Given（前提）**:
  - `newuser@example.com` は未登録
  - ユーザーは未ログイン状態
- **When（操作）**:
  - ログイン画面（`/login`）にアクセス
  - 「新規登録」タブをクリック
  - Emailフィールドに `newuser@example.com` を入力
  - Passwordフィールドに `Password123` を入力
  - Display Nameフィールドに `新規ユーザー` を入力
  - 「登録」ボタンをクリック
- **Then（結果）**:
  - ダッシュボード画面（`/dashboard`）へリダイレクトされる
  - ヘッダーに「新規ユーザー」が表示される
  - localStorageにトークンが保存される

#### シナリオ3: returnUrlへのリダイレクト

- **Given（前提）**:
  - ユーザーは未ログイン状態
  - `/projects` にアクセスしようとした
- **When（操作）**:
  - AuthGuardにより `/login?returnUrl=/projects` へリダイレクトされる
  - 正しい認証情報でログイン
- **Then（結果）**:
  - `/projects` へリダイレクトされる（`/dashboard` ではなく）

#### シナリオ4: ログイン状態の維持

- **Given（前提）**:
  - ユーザーはログイン済み
  - localStorageにトークンが保存されている
- **When（操作）**:
  - ブラウザをリロード
- **Then（結果）**:
  - ログイン状態が維持される
  - ヘッダーにユーザー名が表示される
  - 再ログイン不要

#### シナリオ5: ログイン済みユーザーのログイン画面アクセス

- **Given（前提）**:
  - ユーザーはログイン済み
- **When（操作）**:
  - `/login` に直接アクセス
- **Then（結果）**:
  - `/dashboard` へリダイレクトされる（guestGuardにより）

---

### 異常系

#### シナリオ6: 認証失敗（パスワード誤り）

- **Given（前提）**:
  - `test@example.com` で登録済み
- **When（操作）**:
  - Emailフィールドに `test@example.com` を入力
  - Passwordフィールドに `WrongPassword` を入力
  - 「ログイン」ボタンをクリック
- **Then（結果）**:
  - ログイン画面に留まる
  - エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される
  - Passwordフィールドがクリアされる

#### シナリオ7: 認証失敗（未登録メールアドレス）

- **Given（前提）**:
  - `notexist@example.com` は未登録
- **When（操作）**:
  - Emailフィールドに `notexist@example.com` を入力
  - Passwordフィールドに `Password123` を入力
  - 「ログイン」ボタンをクリック
- **Then（結果）**:
  - ログイン画面に留まる
  - エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される

#### シナリオ8: バリデーションエラー（必須項目未入力）

- **Given（前提）**:
  - ユーザーは未ログイン状態
- **When（操作）**:
  - Emailフィールドを空のまま
  - Passwordフィールドを空のまま
  - 「ログイン」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - 各フィールドに「必須項目です」エラーが表示される

#### シナリオ9: バリデーションエラー（Email形式不正）

- **Given（前提）**:
  - ユーザーは未ログイン状態
- **When（操作）**:
  - Emailフィールドに `invalid-email` を入力
  - Passwordフィールドに `Password123` を入力
  - 「ログイン」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - Emailフィールドに「有効なメールアドレスを入力してください」エラーが表示される

#### シナリオ10: バリデーションエラー（パスワード文字数不足）

- **Given（前提）**:
  - ユーザーは未ログイン状態
  - 「新規登録」タブを選択
- **When（操作）**:
  - Emailフィールドに `test@example.com` を入力
  - Passwordフィールドに `short` を入力（8文字未満）
  - Display Nameフィールドに `テスト` を入力
  - 「登録」ボタンをクリック
- **Then（結果）**:
  - APIリクエストは送信されない
  - Passwordフィールドに「パスワードは8文字以上で入力してください」エラーが表示される

#### シナリオ11: 新規登録失敗（メールアドレス重複）

- **Given（前提）**:
  - `existing@example.com` は登録済み
  - 「新規登録」タブを選択
- **When（操作）**:
  - Emailフィールドに `existing@example.com` を入力
  - Passwordフィールドに `Password123` を入力
  - Display Nameフィールドに `既存ユーザー` を入力
  - 「登録」ボタンをクリック
- **Then（結果）**:
  - 新規登録画面に留まる
  - エラーメッセージ「このメールアドレスは既に登録されています」が表示される

---

## E2Eテスト（/webapp-testing用）

### テストスイート構成

```typescript
describe('認証機能', () => {
  describe('ログイン', () => {
    it('正しい認証情報でログインできる');
    it('誤ったパスワードでエラーが表示される');
    it('未入力でバリデーションエラーが表示される');
    it('returnUrlへリダイレクトされる');
  });

  describe('新規登録', () => {
    it('新規ユーザーを登録できる');
    it('重複メールアドレスでエラーが表示される');
    it('パスワード文字数不足でエラーが表示される');
  });

  describe('認証状態', () => {
    it('ログイン状態がリロード後も維持される');
    it('ログイン済みユーザーはログイン画面にアクセスできない');
  });
});
```

---

## 関連ドキュメント

- `docs/design/angular-ui-design.md` - ログイン画面ワイヤーフレーム
- `docs/design/angular-architecture.md` - 認証フロー設計
- `docs/user-stories/US013_BFF認証.md` - BFF認証API仕様
