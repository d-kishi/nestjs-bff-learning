# US006: コメント投稿

## ストーリー

MEMBERユーザーとして、
タスクにコメントを投稿したい。
それにより、タスクに関する情報共有や進捗報告ができる。

## 受け入れ基準

- タスクに対してコメントを投稿できる
- コメント内容は1〜2000文字
- 投稿者（authorId）は自動で設定される
- 自分が投稿したコメントは編集・削除できる
- ADMINユーザーは他者のコメントも削除できる

## アンチパターン（これは仕様に含まない）

- コメントへの返信（ネスト）機能はない
- コメントへのリアクション（いいね等）機能はない
- コメント内でのメンション（@ユーザー名）機能はない
- 画像やファイルの添付はできない
- コメントの編集履歴は記録しない

## テストシナリオ

### 正常系

#### シナリオ1: コメントを投稿

- **Given（前提）**: タスク（id: 1）が存在し、ユーザー（id: 123）がログイン中
- **When（操作）**: POST /tasks/1/comments に `{"content": "進捗報告です"}` を送信
- **Then（結果）**:
  - HTTPステータス 201 が返る
  - `authorId` が 123 で設定されている
  - `taskId` が 1 で設定されている
  - `createdAt` が設定されている

#### シナリオ2: コメント一覧を取得

- **Given（前提）**: タスク（id: 1）に3件のコメントがある
- **When（操作）**: GET /tasks/1/comments を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - `data` に3件のコメントが含まれる
  - 各コメントに `id`, `content`, `authorId`, `createdAt` が含まれる

#### シナリオ3: 自分のコメントを編集

- **Given（前提）**: ユーザー（id: 123）が投稿したコメント（id: 1）が存在する
- **When（操作）**: PATCH /comments/1 に `{"content": "更新後のコメント"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - `content` が更新されている
  - `updatedAt` が更新されている

#### シナリオ4: 自分のコメントを削除

- **Given（前提）**: ユーザー（id: 123）が投稿したコメント（id: 1）が存在する
- **When（操作）**: DELETE /comments/1 を送信
- **Then（結果）**:
  - HTTPステータス 204 が返る
  - コメントが削除されている

#### シナリオ5: ADMINが他者のコメントを削除

- **Given（前提）**: ユーザー（id: 456）が投稿したコメント（id: 1）が存在し、ADMIN（id: 123）がログイン中
- **When（操作）**: DELETE /comments/1 を送信（X-User-Roles: ADMIN）
- **Then（結果）**:
  - HTTPステータス 204 が返る
  - コメントが削除されている

### 異常系

#### シナリオ6: 空のコメントを投稿

- **Given（前提）**: タスクが存在する
- **When（操作）**: POST /tasks/1/comments に `{"content": ""}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `TASK_COMMENT_VALIDATION_ERROR`

#### シナリオ7: 存在しないタスクにコメント

- **Given（前提）**: タスクID 999 は存在しない
- **When（操作）**: POST /tasks/999/comments に `{"content": "コメント"}` を送信
- **Then（結果）**:
  - HTTPステータス 404 が返る
  - エラーコード `TASK_TASK_NOT_FOUND`

#### シナリオ8: 他者のコメントを編集しようとする

- **Given（前提）**: ユーザー（id: 456）が投稿したコメント（id: 1）が存在し、ユーザー（id: 123, Role: MEMBER）がログイン中
- **When（操作）**: PATCH /comments/1 に `{"content": "変更"}` を送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `TASK_COMMENT_FORBIDDEN`

#### シナリオ9: MEMBERが他者のコメントを削除しようとする

- **Given（前提）**: ユーザー（id: 456）が投稿したコメント（id: 1）が存在し、MEMBER（id: 123）がログイン中
- **When（操作）**: DELETE /comments/1 を送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `TASK_COMMENT_FORBIDDEN`

## 関連

- US003: タスク作成（コメント対象のタスクが必要）
- US004: タスク一覧取得
