# US008: ユーザー登録

## ストーリー

未登録ユーザーとして、
メールアドレスとパスワードでアカウントを登録したい。
それにより、システムにログインしてタスク管理機能を利用できる。

## 受け入れ基準

- メールアドレス（必須）とパスワード（必須）を入力してユーザー登録できる
- 表示名（displayName）は任意で指定でき、省略時はメールアドレスのローカルパートが設定される
- 登録成功時、Access TokenとRefresh Tokenが発行される
- 登録されたユーザーには自動的にMEMBERロールが付与される
- パスワードは8文字以上で、英字と数字を含む必要がある

## アンチパターン（これは仕様に含まない）

- 登録時にロールを指定することはできない（常にMEMBER）
- メールアドレスの確認（verification）機能は実装しない（学習用のため）
- 同一メールアドレスでの重複登録はできない
- パスワードは平文で保存しない（bcryptでハッシュ化）

## テストシナリオ

### 正常系

#### シナリオ1: 全項目を指定してユーザー登録

- **Given（前提）**: 未登録の状態
- **When（操作）**: POST /auth/register に `{"email": "test@example.com", "password": "Password123", "displayName": "テストユーザー"}` を送信
- **Then（結果）**:
  - HTTPステータス 201 が返る
  - レスポンスに `user.id`, `user.email`, `user.profile.displayName`, `accessToken`, `refreshToken` が含まれる
  - `user.roles` に `MEMBER` が含まれる

#### シナリオ2: displayNameを省略してユーザー登録

- **Given（前提）**: 未登録の状態
- **When（操作）**: POST /auth/register に `{"email": "test2@example.com", "password": "Password123"}` を送信
- **Then（結果）**:
  - HTTPステータス 201 が返る
  - `user.profile.displayName` が `test2`（メールのローカルパート）になる

### 異常系

#### シナリオ3: 既存のメールアドレスで登録

- **Given（前提）**: `existing@example.com` が既に登録済み
- **When（操作）**: POST /auth/register に `{"email": "existing@example.com", "password": "Password123"}` を送信
- **Then（結果）**:
  - HTTPステータス 409 が返る
  - エラーコード `USER_AUTH_EMAIL_ALREADY_EXISTS` が返る

#### シナリオ4: パスワードが8文字未満

- **Given（前提）**: 未登録の状態
- **When（操作）**: POST /auth/register に `{"email": "test@example.com", "password": "Pass1"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_AUTH_VALIDATION_ERROR` が返る
  - エラーメッセージに「8文字以上」が含まれる

#### シナリオ5: パスワードに数字が含まれない

- **Given（前提）**: 未登録の状態
- **When（操作）**: POST /auth/register に `{"email": "test@example.com", "password": "PasswordOnly"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_AUTH_VALIDATION_ERROR` が返る

#### シナリオ6: 無効なメールアドレス形式

- **Given（前提）**: 未登録の状態
- **When（操作）**: POST /auth/register に `{"email": "invalid-email", "password": "Password123"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_AUTH_VALIDATION_ERROR` が返る

## 関連

- US009: ログイン
- US010: プロフィール更新（登録後に詳細プロフィールを設定）
