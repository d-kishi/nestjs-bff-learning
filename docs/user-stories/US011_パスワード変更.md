# US011: パスワード変更

## ストーリー

登録済みユーザーとして、
自分のパスワードを変更したい。
それにより、セキュリティを維持できる。

## 受け入れ基準

- 現在のパスワードと新しいパスワードを入力してパスワードを変更できる
- 新しいパスワードは登録時と同じ要件を満たす必要がある（8文字以上、英字と数字を含む）
- パスワード変更は本人のみ可能（ADMINも他人のパスワードは変更不可）
- パスワード変更後も既存のセッション（Access Token）は有効

## アンチパターン（これは仕様に含まない）

- ADMINが他ユーザーのパスワードを変更することはできない（セキュリティ）
- 「パスワードを忘れた」によるリセット機能は実装しない（学習用のため）
- 過去に使用したパスワードの再利用チェックは実装しない
- パスワード変更時に全デバイスからログアウトする機能は実装しない

## テストシナリオ

### 正常系

#### シナリオ1: 正しい現在のパスワードで新しいパスワードに変更

- **Given（前提）**: ユーザーID 1 でログイン済み、現在のパスワードは `OldPassword123`
- **When（操作）**: PATCH /users/1/password に `{"currentPassword": "OldPassword123", "newPassword": "NewPassword456"}` を送信
- **Then（結果）**:
  - HTTPステータス 200 が返る
  - 成功メッセージが返る
  - 次回ログイン時は `NewPassword456` でログインできる
  - `OldPassword123` ではログインできなくなる

### 異常系

#### シナリオ2: 現在のパスワードが間違っている

- **Given（前提）**: ユーザーID 1 でログイン済み
- **When（操作）**: PATCH /users/1/password に `{"currentPassword": "WrongPassword", "newPassword": "NewPassword456"}` を送信
- **Then（結果）**:
  - HTTPステータス 401 が返る
  - エラーコード `USER_USER_INVALID_PASSWORD` が返る

#### シナリオ3: 新しいパスワードが要件を満たさない（8文字未満）

- **Given（前提）**: ユーザーID 1 でログイン済み、現在のパスワードは `OldPassword123`
- **When（操作）**: PATCH /users/1/password に `{"currentPassword": "OldPassword123", "newPassword": "Short1"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_USER_VALIDATION_ERROR` が返る

#### シナリオ4: 新しいパスワードに数字が含まれない

- **Given（前提）**: ユーザーID 1 でログイン済み、現在のパスワードは `OldPassword123`
- **When（操作）**: PATCH /users/1/password に `{"currentPassword": "OldPassword123", "newPassword": "NoNumbersHere"}` を送信
- **Then（結果）**:
  - HTTPステータス 400 が返る
  - エラーコード `USER_USER_VALIDATION_ERROR` が返る

#### シナリオ5: 他人のパスワードを変更しようとする

- **Given（前提）**: ユーザーID 1 でログイン済み
- **When（操作）**: PATCH /users/2/password にパスワード変更リクエストを送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `USER_USER_FORBIDDEN` が返る

#### シナリオ6: ADMINが他人のパスワードを変更しようとする

- **Given（前提）**: ADMINユーザー（X-User-Id: 1, X-User-Roles: ADMIN）でログイン済み
- **When（操作）**: PATCH /users/2/password にパスワード変更リクエストを送信
- **Then（結果）**:
  - HTTPステータス 403 が返る
  - エラーコード `USER_USER_FORBIDDEN` が返る
  - 理由：パスワード変更は本人のみ可能

## 関連

- US008: ユーザー登録（パスワード要件の定義）
- US009: ログイン
