# ADR-0006: Playwright E2Eテストは認証フローのみに限定

## ステータス

承認

## コンテキスト

Phase 4 Angular統合において、E2Eテストの導入範囲を決定する必要があった。

### 現在のテスト状況

| レイヤー | テスト数 | カバレッジ |
|---------|---------|-----------|
| task-service | 155 | 十分 |
| user-service | 95 | 十分 |
| api-gateway (BFF) | 166 | 十分 |
| **Angular ↔ BFF統合** | **0** | **未カバー** |

### 検討すべき観点

1. プロジェクトの目的（NestJS BFF学習、Angular学習は主目的ではない）
2. 工数対効果（シンプルなUIに時間をかけない方針）
3. 品質保証（どこまでテストで担保すべきか）

## 決定

**Playwright E2Eテストは認証フローのみに限定し、正常系5ケースのみ実施する。**

### テスト対象

| 対象 | E2Eテスト | 理由 |
|------|----------|------|
| 認証フロー | ✅ 実施 | Interceptor・Guard連携が複雑、手動では見落としやすい |
| CRUD操作 | ❌ 手動 | BFF側でテスト済み、シンプルな操作 |

### テストシナリオ（5ケース）

1. ログイン成功 → ダッシュボード表示
2. 新規登録成功 → ダッシュボード表示
3. 未認証時 → ログイン画面リダイレクト
4. ログアウト → ログイン画面遷移
5. リロード後もログイン状態維持

## 理由

### 認証フローをE2E対象とする理由

1. **複雑な連携**: Interceptor（Bearer Token付与、401時リフレッシュ）、Guard（authGuard, adminGuard）、localStorage操作が連携
2. **手動テストの限界**: トークンリフレッシュやリダイレクト動作は手動確認が煩雑
3. **リグレッションリスク**: 認証が壊れるとシステム全体が使用不能になる

### CRUD操作を対象外とする理由

1. **BFF層でテスト済み**: 166テストで十分カバー
2. **シンプルな操作**: API呼び出し→表示更新のみ、複雑な状態遷移なし
3. **工数対効果**: 全画面E2Eは工数大、学習プロジェクトには過剰

### 検討した代替案

| 代替案 | 不採用理由 |
|-------|-----------|
| E2Eテストなし（手動のみ） | 認証フローの複雑さから、手動では見落としリスクが高い |
| 全画面E2Eテスト | 工数が大きく、Angular学習が主目的ではないプロジェクトには過剰 |
| 異常系も含めたE2Eテスト | 正常系で動作確認できれば十分。異常系はBFF側でテスト済み |

## 影響

### メリット

- 最小限の工数で認証フローの品質を担保
- Playwright MCP学習の機会を得られる
- リグレッション検出の自動化

### デメリット・トレードオフ

- CRUD操作のリグレッションは手動確認が必要
- 異常系（認証失敗、バリデーションエラー）はE2E対象外

### 技術的影響

- `.devcontainer/devcontainer.json` にPlaywrightブラウザインストールを追加
- `frontend/angular-app/e2e/` にテストファイルを配置
- コンポーネントに `data-testid` 属性を付与
- E2Eテスト実行: `cd frontend/angular-app && npm run test:e2e`

## 関連ドキュメント

- `docs/design/angular-architecture.md` - E2Eテスト設計セクション
- `docs/user-stories/US015_Angularログイン.md` - E2Eテストシナリオ詳細
