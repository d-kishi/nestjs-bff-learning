# 2025-12-31 セッション記録

## セッション概要

| 項目 | 内容 |
|------|------|
| 目的 | プロジェクト初期セットアップ（Phase 0） |
| 作業特性 | 新機能実装（プロジェクト立ち上げ） |

## 完了事項

### 基本セットアップ
- README.md作成（企画書の要約版）
- CLAUDE.md生成・調整（/init実行）
- package.json作成（npm workspaces設定）
- .gitignore作成

### ディレクトリ構造
- services/（task-service, user-service, api-gateway）
- frontend/angular-app/
- database/init/
- docs/（user-stories, units, adr）
- .devcontainer/

### 各ディレクトリREADME.md
- 全13ファイル作成
- 各ディレクトリの役割・格納ファイルを説明

### セッション管理Command
- session-start.md移植（軽量版）
- session-end.md移植（軽量版）
- docs/sessions/ディレクトリ構造作成
  - project-status.md
  - task-checklist.md
  - daily/README.md（テンプレート）

### ADRファイル
- 0000-template.md
- 0001-oracle-same-instance-separate-schema.md
- 0002-no-sdd-tools.md
- 0003-npm-workspaces-monorepo.md
- 0004-coderabbit-review-strategy.md
- docs/adr/README.md更新（一覧・既存ドキュメントとの役割分担）

## 技術的知見・学び

- CLAUDE.md/README.mdで十分カバーできる設計判断はADRファイル化不要
- セッション管理CommandはSerena依存部分を削除し、ファイルベースで代替可能

### Oracle Container Registry認証手順（Auth Token方式）

Oracle Container Registryへの`docker login`で「unauthorized: Auth failed」エラーが発生する場合、通常のパスワードではなく**Auth Token（シークレットキー）** を使用することで解決できる。

#### 背景・問題

```
docker login container-registry.oracle.com
# ユーザー名: メールアドレス
# パスワード: Oracleアカウントのパスワード
# → Error response from daemon: unauthorized: Auth failed.
```

通常のOracleアカウントパスワードでは認証に失敗するケースがある。

#### 解決手順

1. **Oracle Container Registryにブラウザでログイン**
   - https://container-registry.oracle.com/ にアクセス
   - 右上「Sign In」からOracleアカウントでログイン

2. **Auth Tokenを生成**
   - 右上の**プロフィール名（アカウント名）** をクリック
   - メニューから「**Auth Token**」を選択
   - 「**Generate Secret Key**」をクリック
   - 生成されたシークレットキーをコピー（**この画面を閉じると再表示不可**）

3. **docker loginでAuth Tokenを使用**
   ```bash
   docker login container-registry.oracle.com
   # Username: Oracleアカウントのメールアドレス
   # Password: 生成したシークレットキー（Auth Token）
   ```

4. **イメージをpull**
   ```bash
   docker pull container-registry.oracle.com/database/express:21.3.0-xe
   ```

#### 補足

- 2025年6月30日以降、Oracle Container RegistryではAuth Token認証が必須になる予定
- ライセンス同意は、リポジトリ詳細ページで事前に完了しておく必要がある（UIが変更されている場合あり）
- シークレットキーは一度しか表示されないため、安全な場所に保管すること

## 発生した問題と解決

### 問題1: Docsディレクトリの大文字/小文字
- **原因**: 初回作成時にDocs（大文字）で作成
- **解決策**: git mvで docs にリネーム

## 未完了・継続事項

- [x] Rules/Skills作成 → 後日検討に決定
- [x] AskUserQuestionルール → CLAUDE.mdに追記完了
- [ ] DevContainer設定
- [ ] Phase 1設計作業（task-serviceエンティティ・API設計）

## 次回への申し送り

- Rules/Skills作成から着手予定
  - CLAUDE.mdのアーキテクチャ設計・APIレスポンスフォーマットをRulesに移動
  - 2件以上の質問時はAskUserQuestion使用のルール追加
- DevContainer設定は基本部分のみ先行
- 開発環境構築（Oracle接続、スキーマSQL等）は設計作業の後に実施

---

## セッション2（同日）

### 完了事項

- Rules/Skills移行の検討 → **後日検討に決定**（現時点ではCLAUDE.mdで十分）
- CLAUDE.mdに「Communication Guidelines」セクション追加（AskUserQuestionルール）
- ADR-0005（Docker Desktop採用）作成
- Docker Desktopインストール・WSL2統合設定
- Oracle Container Registryへのログイン成功（Auth Token方式）

### 発生した問題と解決

#### 問題2: Oracle Container Registry認証エラー

- **現象**: `docker login container-registry.oracle.com` で「unauthorized: Auth failed」
- **原因**: 通常のOracleパスワードでは認証できない
- **解決策**: Auth Token（シークレットキー）を生成して使用
- **詳細手順**: 「技術的知見・学び」セクションに記載

### 未完了・継続事項

- [ ] Oracle XEイメージのpull確認（ログイン成功後、pullは未実施）
- [ ] DevContainer設定ファイル作成
- [ ] Phase 1設計作業

### 次回への申し送り

#### DevContainer設定（次回で完了予定）

1. **作成するファイル**
   - `.devcontainer/devcontainer.json`
   - `.devcontainer/docker-compose.yml`
   - `.devcontainer/Dockerfile`

2. **Oracle XEイメージ（公式）**
   ```
   container-registry.oracle.com/database/express:21.3.0-xe
   ```
   ※ログイン済み。pullは次回実施。

3. **VS Code拡張機能（決定済み）**

   | カテゴリ | 拡張機能 |
   |---------|---------|
   | 基本 | ESLint, Prettier, Jest |
   | NestJS | NestJS Files, NestJS Snippets |
   | 初心者向け | REST Client, npm Intellisense, Path Intellisense |
   | TypeScript | Pretty TypeScript Errors |

4. **Dockerfile構成**
   - ベース: `mcr.microsoft.com/devcontainers/javascript-node:20`
   - Oracle Instant Client インストール
   - CodeRabbit CLI インストール（オプション）

---

## セッション3（同日）

### 完了事項

- Oracle XEイメージpull完了
- DevContainerファイル作成
  - `.devcontainer/devcontainer.json`
  - `.devcontainer/docker-compose.yml`
  - `.devcontainer/Dockerfile`
- DevContainer起動確認・動作検証完了

### DevContainer環境確認結果

| 項目 | バージョン/状態 |
|------|----------------|
| appコンテナ | 正常起動 |
| oracleコンテナ | 正常起動 (healthy) |
| Node.js | v20.19.6 |
| npm | 10.8.2 |
| Oracle Instant Client | 23.4 |
| Oracle XE接続 | 成功 (XEPDB1) |

### 技術的知見・学び

#### Debian Trixieでのlibaioパッケージ

Debian Trixie（testing）では`libaio1`パッケージが`libaio1t64`にリネームされている。
Dockerfileでは以下のように記述する必要がある：

```dockerfile
RUN apt-get update && apt-get install -y libaio1t64 wget unzip \
```

### Phase 0完了

DevContainer環境構築が完了し、Phase 0（初期セットアップ）が完了。
次回からPhase 1（task-service実装）の設計作業に着手可能。

### ルール追加

- `.claude/rules/code-comments.md` を作成
- 学習目的のため、日本語で丁寧なコードコメントを記載するルール
- 「なぜこの実装か」の設計意図を重視

### CLAUDE.md更新

- Commandsセクションに実行環境の注意書きを追加
- Claude CodeはWindowsホスト、アプリはDevContainerという環境差異を明記
- `docker exec`形式でのコマンド実行を案内

### Qiita記事素材作成

- `C:\Develop\qiita-tech-blog\drafts\nestjs-bff-devcontainer-setup\`に素材ファイル作成
- 記事構成案、プロジェクト企画、アーキテクチャ設計、DevContainer構築手順、トラブルシューティング、作成ファイル一覧
- 特に価値のある内容：Oracle Container Registry Auth Token認証、Debian Trixieのlibaio問題

### 次回への申し送り

- Phase 1設計作業開始
  - task-serviceエンティティ詳細設計（Project, Task, Comment, Tag）
  - task-service API設計
  - ユーザーストーリー作成
- 読み込み推奨: `docs/project-plan.md`（企画書）
