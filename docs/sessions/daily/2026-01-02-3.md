# 2026-01-02 セッション記録 (3)

## セッション概要

| 項目 | 内容 |
|------|------|
| 目的 | TDD動作確認 + task-service雛形作成 |
| 作業特性 | 新機能実装 / 調査分析 |

## 完了事項

### TDD動作確認
- Forced Eval Hook正常動作を確認
- skills-triggers.jsonから1件のSkill読み込み成功

### task-service雛形作成
- `nest new task-service` 実行
- NestJS 11 + TypeScript環境構築

### TypeORM + Oracle接続設定
- `src/app.module.ts`: TypeORM設定追加（ConfigModule使用）
- `src/main.ts`: ValidationPipe設定、ポート3001
- `src/common/dto/api-response.dto.ts`: 統一レスポンス型

### Oracleスキーマ作成
- `database/init/01_create_task_schema.sql`: TASK_DB/TASK_DB_TESTユーザー作成
- スキーマ作成SQL実行完了

### 依存関係インストール
- @nestjs/typeorm, typeorm, oracledb
- @nestjs/config, class-validator, class-transformer

## 技術的知見・学び

### Docker Desktop + WSL2のIPv4/IPv6問題
- Docker Desktop (WSL2) 環境では、IPv4のlocalhost (127.0.0.1) からコンテナへのポートフォワーディングが不安定
- IPv6 (::1) 経由のポートフォワーディングは正常動作
- A5M2の直接接続でIPv6を有効化することで解決

### Oracle Instant Client互換性
- Instant Client 23.8はA5M2 2.20.4と互換性問題あり（フリーズ）
- Instant Client 21.18でも同様の症状
- 根本原因はInstant ClientではなくDocker + WSL2のネットワーク問題

## 発生した問題と解決

### 問題1: A5M2でOracle接続時にフリーズ
- **症状**: 接続試行時にA5M2が応答なし、Oracleリスナーログに接続試行の記録なし
- **調査**: TCP接続は成功、Dockerポートマッピング正常、Oracle側正常
- **原因**: Docker Desktop + WSL2環境でのIPv4ポートフォワーディング問題
- **解決策**: A5M2の直接接続（OCI不使用）でIPv6を有効化

### 問題2: OCI接続が失敗する理由
- Oracle Instant ClientはデフォルトでIPv4を優先
- IPv6への切り替えオプションが容易に提供されていない
- 直接接続はIPv6オプションをUI設定可能

## 作成・変更ファイル

| ファイル | 操作 |
|---------|------|
| `services/task-service/` | NestJSプロジェクト作成 |
| `services/task-service/src/app.module.ts` | TypeORM設定追加 |
| `services/task-service/src/main.ts` | ValidationPipe、ポート3001設定 |
| `services/task-service/src/common/dto/api-response.dto.ts` | 統一レスポンス型 |
| `services/task-service/src/common/dto/index.ts` | エクスポート |
| `database/init/01_create_task_schema.sql` | スキーマ作成SQL |

## 未完了・継続事項

- [ ] エンティティ実装（Project → Task → Comment → Tag）
- [ ] API実装（CRUD）
- [ ] テスト実装（Unit / E2E）

## 次回への申し送り

### 実装開始
- Projectエンティティから実装開始
- TDDサイクル（テストファースト）で進める
- 設計参照: `docs/design/task-service-entities.md`, `docs/design/task-service-api.md`

### DB接続確認
- A5M2: 直接接続 + IPv6有効で接続可能
- サーバー名: `localhost:1521/XEPDB1`
- ユーザー: `TASK_DB` / パスワード: `task_password`

### 注意事項
- Docker Desktop + WSL2環境ではIPv6接続を使用
- OCI接続（Instant Client使用）はIPv4問題により非推奨
