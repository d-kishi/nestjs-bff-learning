<!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ç”»é¢ -->
<div class="task-list">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="task-list__header">
    <h1 class="task-list__title">ã‚¿ã‚¹ã‚¯</h1>
    <button type="button" class="task-list__create-btn" (click)="openCreateDialog()">
      æ–°è¦ä½œæˆ
    </button>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ -->
  <div class="task-list__filters">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <select
      name="statusFilter"
      class="task-list__filter-select"
      aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
      [ngModel]="statusFilter()"
      (ngModelChange)="statusFilter.set($event); onFilterChange()"
    >
      <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
      @for (status of statusOptions; track status) {
        <option [value]="status">{{ status }}</option>
      }
    </select>

    <!-- å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <select
      name="priorityFilter"
      class="task-list__filter-select"
      aria-label="å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
      [ngModel]="priorityFilter()"
      (ngModelChange)="priorityFilter.set($event); onFilterChange()"
    >
      <option value="">ã™ã¹ã¦ã®å„ªå…ˆåº¦</option>
      @for (priority of priorityOptions; track priority) {
        <option [value]="priority">{{ priority }}</option>
      }
    </select>

    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <select
      name="projectFilter"
      class="task-list__filter-select"
      aria-label="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
      [ngModel]="projectFilter()"
      (ngModelChange)="projectFilter.set($event ? +$event : null); onFilterChange()"
    >
      <option [ngValue]="null">ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
      @for (project of projectsService.projects(); track project.id) {
        <option [ngValue]="project.id">{{ project.name }}</option>
      }
    </select>

    <!-- ã‚½ãƒ¼ãƒˆ -->
    <div class="task-list__sort">
      <select
        name="sortBy"
        class="task-list__filter-select"
        aria-label="ä¸¦ã³é †"
        [ngModel]="sortBy()"
        (ngModelChange)="sortBy.set($event); onSortChange()"
      >
        <option value="createdAt">ä½œæˆæ—¥</option>
        <option value="dueDate">æœŸé™æ—¥</option>
        <option value="priority">å„ªå…ˆåº¦</option>
      </select>
      <button
        type="button"
        class="task-list__sort-order"
        (click)="sortOrder.set(sortOrder() === 'asc' ? 'desc' : 'asc'); onSortChange()"
        [title]="sortOrder() === 'asc' ? 'æ˜‡é †' : 'é™é †'"
        [attr.aria-label]="sortOrder() === 'asc' ? 'æ˜‡é †ã§ä¸¦ã¹æ›¿ãˆä¸­ã€ã‚¯ãƒªãƒƒã‚¯ã§é™é †ã«å¤‰æ›´' : 'é™é †ã§ä¸¦ã¹æ›¿ãˆä¸­ã€ã‚¯ãƒªãƒƒã‚¯ã§æ˜‡é †ã«å¤‰æ›´'"
      >
        {{ sortOrder() === 'asc' ? 'â†‘' : 'â†“' }}
      </button>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  @if (tasksService.isLoading()) {
    <app-loading-spinner [overlay]="true" message="èª­ã¿è¾¼ã¿ä¸­..." />
  }

  <!-- ã‚¨ãƒ©ãƒ¼ -->
  @if (tasksService.error()) {
    <div class="task-list__error">
      <p>{{ tasksService.error() }}</p>
      <button type="button" class="task-list__retry-btn" (click)="tasksService.loadTasks()">
        å†è©¦è¡Œ
      </button>
    </div>
  }

  <!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
  @if (!tasksService.isLoading() && !tasksService.error()) {
    @if (tasksService.tasks().length === 0) {
      <div class="task-list__empty">
        <p>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
        <p class="task-list__empty-hint">ã€Œæ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
      </div>
    } @else {
      <div class="task-list__table-wrapper">
        <table class="task-list__table" aria-label="ã‚¿ã‚¹ã‚¯ä¸€è¦§">
          <thead>
            <tr>
              <th scope="col">ã‚¿ã‚¤ãƒˆãƒ«</th>
              <th scope="col">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
              <th scope="col">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th scope="col">å„ªå…ˆåº¦</th>
              <th scope="col">æœŸé™</th>
              <th scope="col">æ‹…å½“è€…</th>
              <th scope="col">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            @for (task of tasksService.tasks(); track task.id) {
              <tr class="task-row">
                <td class="task-row__title">{{ task.title }}</td>
                <td class="task-row__project">{{ task.projectName }}</td>
                <td class="task-row__status">
                  <select
                    class="task-row__status-select task-row__status-select--{{ (task.status || '') | lowercase }}"
                    [ngModel]="task.status"
                    (ngModelChange)="onStatusChange(task.id, $event)"
                  >
                    @for (status of statusOptions; track status) {
                      <option [value]="status">{{ status }}</option>
                    }
                  </select>
                </td>
                <td class="task-row__priority">
                  <span class="task-row__priority-badge task-row__priority-badge--{{ (task.priority || '') | lowercase }}">
                    {{ task.priority }}
                  </span>
                </td>
                <td class="task-row__due">{{ task.dueDate ? (task.dueDate | date:'yyyy/MM/dd') : '-' }}</td>
                <td class="task-row__assignee">{{ task.assigneeName || 'æœªå‰²å½“' }}</td>
                <td class="task-row__actions">
                  <button
                    type="button"
                    class="task-row__edit-btn"
                    (click)="openEditDialog(task)"
                    aria-label="ç·¨é›†"
                  >
                    âœï¸
                  </button>
                  <button
                    type="button"
                    class="task-row__delete-btn"
                    (click)="openDeleteConfirm(task)"
                    aria-label="å‰Šé™¤"
                  >
                    ğŸ—‘ï¸
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
      @if (tasksService.totalPages() > 1) {
        <app-pagination
          [currentPage]="tasksService.currentPage()"
          [totalPages]="tasksService.totalPages()"
          (pageChange)="onPageChange($event)"
        />
      }
    }
  }

  <!-- ã‚¿ã‚¹ã‚¯ä½œæˆ/ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  @if (isDialogOpen()) {
    <app-task-dialog
      [mode]="dialogMode()"
      [task]="editingTask()"
      [projects]="projectsService.projects()"
      (save)="onSave($event)"
      (cancel)="closeDialog()"
    />
  }

  <!-- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <app-confirm-dialog
    [isOpen]="isConfirmDialogOpen()"
    type="danger"
    title="ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤"
    [message]="'ã€Œ' + (deletingTask()?.title || '') + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'"
    confirmText="å‰Šé™¤"
    cancelText="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
    (confirm)="onConfirmDelete()"
    (cancel)="closeDeleteConfirm()"
  />
</div>
